#include "PWM.h"
#include "stm32f4xx.h"

//Timer clock is TIMER_CLOCK: 42000000
void PWMinit(void){
	RCC->APB2ENR|=RCC_APB2ENR_TIM1EN;


	//PWMA: Channel 2
	GPIOA ->MODER |= GPIO_MODER_MODER1_1;
	GPIOA->OSPEEDR |= GPIO_OSPEEDER_OSPEEDR1;
	GPIOA->OTYPER &=~(GPIO_OTYPER_OT_1);
	GPIOA->PUPDR  &=~(GPIO_PUPDR_PUPDR1);
	GPIOA ->AFR[0]&=~0x000000FF;
	GPIOA ->AFR[0]|=0x00000010;

	//PWMB: Channel 1
	GPIOB ->MODER |= GPIO_MODER_MODER13_1;
	GPIOB->OSPEEDR |= GPIO_OSPEEDER_OSPEEDR13;
	GPIOB->OTYPER &=~(GPIO_OTYPER_OT_13);
    GPIOB->PUPDR  &=~(GPIO_PUPDR_PUPDR13);

	GPIOB ->AFR[1]|=0x00100000;



	TIM1->CR1&=~TIM_CR1_DIR;
	TIM1->PSC =39;

	TIM1->ARR  =999;//Period
	//TIM2->CCR1 =2000;//Duty Cycle or part of the period
	//TIM2->CCR2 =2000;//Duty Cycle or part of the period
	TIM1->CCMR1&=~TIM_CCMR1_OC1M;
	TIM1->CCMR1&=~TIM_CCMR1_OC2M;

	TIM1->CCMR1|=TIM_CCMR1_OC2M_2|TIM_CCMR1_OC2M_1;
	TIM1->CCMR1|=TIM_CCMR1_OC1M_2|TIM_CCMR1_OC1M_1;
	TIM1->CCMR1|=TIM_CCMR1_OC1PE;
	TIM1->CCMR1|=TIM_CCMR1_OC2PE;

	TIM1->CCMR1&=~TIM_CCER_CC1NP;
	TIM1->CCMR1&=~TIM_CCER_CC2NP;

	TIM1->CCER|=TIM_CCER_CC1NE;
	TIM1->CCER|=TIM_CCER_CC2NE;

	TIM1->BDTR|=TIM_BDTR_MOE;


	TIM1->CCR1 =100;//Duty Cycle or part of the period
	TIM1->CCR2 =999;//Duty Cycle or part of the period


	TIM1->CR1|=TIM_CR1_CEN;






}
